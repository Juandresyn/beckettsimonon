$(window).on('load', function() {
  if ($('body').hasClass('page--article')) {
    var articleSlider = $('.js-article-gallery');
    var articleSliderArrowPrev = $('.js-article-carousel__prev');
    var articleSliderArrowNext = $('.js-article-carousel__next');

    articleSlider.slick({
      centerMode: true,
      centerPadding: '350px',
      infinite: true,
      slidesToShow: 1,
      slidesToScroll: 1,
      arrows: false,
      responsive: [
        {
          breakpoint: 1024,
          settings: {
            centerPadding: '200px',
          }
        },
        {
          breakpoint: 768,
          settings: {
            centerPadding: '80px',
          }
        },
        {
          breakpoint: 480,
          settings: {
            centerPadding: '40px',
          }
        },
      ],
    });

    articleSliderArrowPrev.on('click', function() {
      articleSlider.slick('slickPrev');
    });

    articleSliderArrowNext.on('click', function() {
      articleSlider.slick('slickNext');
    });
  }
});

// Cart Template '/cart' scripts
function updateItem(el, type) {
  var $input = $(el).siblings('.js-quantity')[0];
  var currentValue = parseInt($input.value);
  var newValue = type === 'add' ? currentValue + 1 : currentValue - 1;
  $input.value = newValue;
}

$('.js-cart .js-quantity-add').on('click', function(e) {
  updateItem(this, 'add');
});

$('.js-cart .js-quantity-less').on('click', function(e) {
  updateItem(this, 'less');
});

if (typeof Vue === 'function') {
  Vue.component('inline-cart-item', {
    name: 'InlineCartItem',

    data: function () {
      return {
        cart: window.cart,
        cart_count: window.window.cart_count,
      };
    },

    methods: {
      cleanTitle(title) {
        return title.split(' -')[0];
      },

      cleanPrice(price) {
        return price.toString().endsWith('00') ? price / 100 : price;
      },

      handleRemoveLink(index) {
        return `/cart/change?line=${index }&amp;quantity=0`;
      },

      updateGlobalCartCount(newQty) {
        document.querySelectorAll('.js-cart-count')
          .forEach((item) => item.innerHTML = newQty);
      },

      updateInlineCartTotalPrice() {
        let totalPrice = 0;
        for (let i = 0; i < this.cart.length; i++) {
          totalPrice += this.cart[i].line_price;
        }

        document.querySelector('.js-inline-cart-total').innerHTML = `$${this.cleanPrice(totalPrice)}`;
      },

      handleQuantity(type, qty, index, price) {
        const totalQty = type === 'add' ? qty + 1 : qty - 1;
        const finalQty = totalQty <= 1 ? 1 : totalQty;
        const globalQty = (this.cart_count - qty) + finalQty;

        this.ajaxUpdateItem(this.cart[index].key, finalQty, () => {
          this.cart_count = globalQty;
          this.cart[index].quantity = finalQty;
          this.cart[index].line_price = price * finalQty;

          this.updateGlobalCartCount(globalQty);
          this.updateInlineCartTotalPrice();
        });
      },

      handleRemoveItem(index) {
        const currentQty = this.cart[index].quantity;
        return this.ajaxUpdateItem(this.cart[index].key, 0, () => {
          this.cart[index].quantity = 0;
          this.cart[index].line_price = 0;

          this.updateGlobalCartCount(this.cart_count - currentQty);
          this.updateInlineCartTotalPrice();
        });
      },

      ajaxUpdateItem(id, quantity, cb) {
        $.ajax({
          method: "POST",
          url: "/cart/change.js",
          dataType: 'json',
          data: {
            id,
            quantity,
          }
        })
        .done(function() {
          cb();
        });
      },
    },

    template: `
      <div class="cart__list">
        <div  v-for="(item, index) in cart"
          :key="index"
          v-if="item.quantity > 0"
          class="cart__item">
          <a :href="item.url">
            <img class="cart-item__image"
              :src="item.image"
              :alt="item.title">
          </a>

          <div class="cart-item__info">
            <h2 class="cart-item__title">{{ cleanTitle(item.title) }}</h2>

            <small class="cart-item__small">{{ item.product_type }}</small>
            <small class="cart-item__small">Size. {{ item.variant_title }}</small>

            <div class="cart-item__quantity">
              <span @click="handleQuantity('less', item.quantity, index, item.price)"
                type="submit"
                class="cart-item__quantity-button">-</span>

              <input
                class="cart-item__quantity-input"
                type="text"
                readonly
                :value="item.quantity" />

              <span @click="handleQuantity('add', item.quantity, index, item.price)"
                type="submit"
                class="cart-item__quantity-button">+</span>
            </div>
          </div>

          <p class="cart-item__price">$ {{ cleanPrice(item.line_price) }}</p>
          <span @click="handleRemoveItem(index)" class="cart-item__remove">Remove</span>
        </div>
      </div>
    `,
  });

  new Vue({
    el: '#inline-cart',
  });
}

if ($('body').hasClass('page--collection')) {
  var navEl = $('.js-all-products__filters');
  var headerEl = $('#shopify-section-header');
  var allProducts = $('.js-all-products');
  var informationNavMaxTop = headerEl.innerHeight();

  $(window).scroll(function() {
    var scrollTop = $(window).scrollTop();

    if (scrollTop >= informationNavMaxTop) {
      navEl.addClass('all-products__filters--fixed');
      allProducts.css({ 'padding-top': navEl.innerHeight() });
    } else {
      navEl.removeClass('all-products__filters--fixed');
      allProducts.css({ 'padding-top': 0 });
    }
  });
}

$('.js-on-click').on('click', function() {
  var target = $(this).data('onclick-target');
  var targetClass = $(this).data('onclick-class');
  var targetClassBehavior = $(this).data('do');

  if(targetClassBehavior && targetClassBehavior === 'add') {
    $(target).addClass(targetClass);
  } else if (targetClassBehavior && targetClassBehavior === 'remove') {
    $(target).removeClass(targetClass);
  } else {
    $(target).toggleClass(targetClass);
  }
});

$('.js-active-on-click').on('click', function() {
  $(this).toggleClass('is-active');
});

$(window).scroll(function(){
  $('.js-on-show').each(function() {
    var target = $(this).data('onshow-target');
    var targetClass = $(this).data('onshow-class');
    if (isScrolledIntoView($(this))) {
      $(this).find(target).addClass(targetClass || 'animate');
    }
  });
});

function isScrolledIntoView(elem){
  var $elem = $(elem);
  var $window = $(window);

  var docViewTop = $window.scrollTop();
  var docViewBottom = docViewTop + $window.height();

  var elemTop = $elem.offset().top;
  var elemBottom = elemTop + $elem.height();

  return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
}

if ($('body').hasClass('page--information')) {
  var navEl = $('.js-information-nav');
  var informationNavMaxTop = window.innerHeight - navEl.innerHeight();

  $(window).scroll(function() {
    var scrollTop = $(window).scrollTop();

    if (scrollTop >= informationNavMaxTop) {
      navEl.addClass('information-nav--fixed');
    } else {
      navEl.removeClass('information-nav--fixed');
    }
  });
}

function resultTemplate(result) {
  return '<li class="search-modal__result"><a href="' + result.url + '" class="search-modal__result-link"><img src="' + result.thumb + '" class="search-modal__result-image" /><div class="search-modal__result-info"><h3 class="search-modal__result-title">' + result.label + '</h3><p class="search-modal__result-price">' + result.price + '</p></div></a></li>';
}

function appendResults(results, $target) {
  for (i = 0; i < results.length; i++) {
    $target.append(resultTemplate(results[i]));
  }
}

$('.js-live-search').on('keyup', function(e) {
  var appendTo = $(this).siblings('.js-live-search-results');
  var searchTerm = e.target.value.toLowerCase();

  if (searchTerm.length >= 3) {
    $.ajax({
      url: "/search",
      data: {
        q: "*" + e.target.value.toLowerCase() + "*",
        type: "product",
        view: "json",
      },
      dataType: "json",
      success: function(data) {
        appendTo.html('');
        appendResults(data, appendTo);
      }
    });
  } else {
    appendTo.html('');
  }
});

$('.js-mega-menu-on-click').on('click', function() {
  var activeClass = 'is-active';
  var target = $(this).data('target');
  $('.' + activeClass).removeClass(activeClass);

  $(this).addClass(activeClass);
  $('[data-item]').hide();
  $('[data-item="'+target+'"]').show();
});

$('.js-mega-menu-close').on('click', function() {
  var activeClass = 'is-active';
  var overlay = $('.js-mega-menu__product');

  overlay.fadeOut();
  $('.' + activeClass).removeClass(activeClass);
});

$(window).on('load', function() {
  $('.js-mega-menu-item').hide();
});

var fillVariants = function(varinats) {
  return varinats.map(function(option){
    return `<option value="${option.id}">${option.title}</option>`;
  }).join('');
};

var fillTemplate = function(product, cb) {
  var img = $('.js-mega-menu__img');
  var title = $('.js-mega-menu__title');
  var price = $('.js-mega-menu__price');
  var url = $('.js-mega-menu__url');
  var type = $('.js-mega-menu__type');
  var size = $('.js-mega-menu__size');
  var variantsWrapper = $('.js-mega-menu-variants');
  var cart = $('.js-mega-menu__cart');

  img.fadeOut(function() {
    title.html(product.title.split(' -')[0]);
    price.html('$'+product.price / 100);
    url.attr('href', product.url);
    size.attr('href', product.url + '?whats-my-size=true');
    type.html(product.type)
    variantsWrapper.html(fillVariants(product.variants));
    img.attr('src', imageService(product.featured_image, 365));
    img.fadeIn();
    cb();
  });
};

$('.js-mega-menu-product').on('click', function(e) {
  e.preventDefault();
  e.stopPropagation();

  var loader = $('.js-mega-menu-loader');
  var overlay = $('.js-mega-menu__product');
  var wrapper = $('.js-mega-menu__wrapper');
  var productHandle = $(this).data('handle');

  overlay.fadeIn();
  loader.fadeIn();
  wrapper.fadeOut();

  $.ajax({
    url: '/products/'+productHandle+'.js',
    method: 'GET',
    dataType: 'json',
    success: function(data) {
      fillTemplate(data, function() {
        loader.fadeOut();
        wrapper.fadeIn();
      });
    }
  });
});

$('.js-mega-menu__cart').on('click', function() {
  var variantId = $('.js-mega-menu-variants').val();

  addToCart(variantId, function(data) {
    window.location.href = '/cart';
  });
});

var siteHeaderHeight = $('[data-section-id="header"]').height() + 20;
var productDetailsHeight = $('.product-header__details').height();
var imagesOffset = $('.product-header__images').height();
var imagesOffsetFinal = (imagesOffset - window.innerHeight) + siteHeaderHeight;
var bottomSize = window.innerHeight - (siteHeaderHeight + productDetailsHeight);
var productToolbarOffset = $('.product-toolbar').height();
var pageScrollClass = 'images-viewed';
var productToolbarBodyClass = 'product-toolbar--visible';
var productPageClass = 'page--product';
var isMobile = window.innerWidth < 1024;

function manageDetailsPosition() {
  var scrollTop = $(window).scrollTop();
  function toolbarCalculation() {
    return isMobile ?
            scrollTop >= ((imagesOffset + productDetailsHeight) - productToolbarOffset) :
            scrollTop >= (imagesOffset - productToolbarOffset);
  }

  if (scrollTop >= (imagesOffsetFinal + bottomSize)) {
    $('body').addClass(pageScrollClass);
  } else if (scrollTop < (imagesOffsetFinal + bottomSize)) {
    $('body').removeClass(pageScrollClass);
  }

  if (toolbarCalculation()) {
    $('body').addClass(productToolbarBodyClass);
  } else {
    $('body').removeClass(productToolbarBodyClass);
  }
}

function initializeEffect() {
  if (imagesOffsetFinal > 0) {
    if ($(window).scrollTop() >= (imagesOffsetFinal + bottomSize)) {
      $('body').addClass(pageScrollClass);
    }
  } else {
    setTimeout(function() {
      initializeEffect();
    }, 1000);
  }
}

if ($('body').hasClass(productPageClass)) {
  initializeEffect();


  $(window).scroll(function() {
    manageDetailsPosition();
  });
}

var $productFilter = $('.js-product-filter');
var $allProducts = $('.js-all-products');
var $allProductsOverlay = $('.js-all-products-overlay');
var allProductActiveClass = "all-products__filters--active";
var productFilterActiveClass = "all-products__filter--active";

$allProductsOverlay.on('click', function() {
  var $activeFilter = $('.'+productFilterActiveClass);
  $activeFilter.removeClass(productFilterActiveClass);
  $allProducts.removeClass(allProductActiveClass);
});

$productFilter.on('click', function() {
  var $this = $(this);
  var $activeFilter = $('.'+productFilterActiveClass);

  if ($activeFilter.length > 0) {
    $activeFilter.not(this).removeClass(productFilterActiveClass);
  }

  if ($this.hasClass(productFilterActiveClass)) {
    $this.removeClass(productFilterActiveClass);
    $allProducts.removeClass(allProductActiveClass);
  } else {
    $this.addClass(productFilterActiveClass);
    $allProducts.addClass(allProductActiveClass);
  }
});

$(window).on('load', function() {
  var mediaSlider = $('.js-slick-product-media');
  var mediaSliderArrowPrev = $('.js-slick-product-media__prev');
  var mediaSliderArrowNext = $('.js-slick-product-media__next');
  var $status = $('.js-slick-product-media-counter');

  mediaSlider.on('init reInit afterChange', function(event, slick, currentSlide, nextSlide){
    var counter = (currentSlide ? currentSlide : 0) + 1;
    $status.text('0' + counter + ' / 0' + slick.slideCount);
  });

  mediaSlider.slick({
    infinite: true,
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false
  });

  mediaSliderArrowPrev.on('click', function() {
    mediaSlider.slick('slickPrev');
  });

  mediaSliderArrowNext.on('click', function() {
    mediaSlider.slick('slickNext');
  });

  $('.js-product-faq-items').accordion({
    active: false,
    collapsible: true,
  });
});

if (typeof Vue === 'function') {
  Vue.component('product-information', {
    name: 'productInformation',

    data: function () {
      return {
        information: window.productMoreInfo,
        productId: window.currentProduct.id,
        productCollection: window.currentProduct.collection,
      };
    },

    computed: {
      infoItem() {
        return this.information[this.productId][this.productCollection] || [];
      },
    },

    template: `
      <span>
        <article v-for="(item, index) in Object.keys(infoItem)"
          :key="index"
          v-if="infoItem[item].image"
          class="product-information__item">
          <div class="product-information__item-image-wrapper">
            <img class="product-information__item-image"
              :src="infoItem[item].image" />
          </div>

          <div class="product-information__item-content">
            <header class="layout-section__header">
              <small class="layout-section__eyebrow">{{ infoItem[item].eyebrow }}</small>
              <h2 class="layout-section__title">{{ infoItem[item].title }}</h2>
              <p class="layout-section__description section--why-us__description">{{ infoItem[item].description }}</p>
            </header>
          </div>
        </article>
      </span>
    `,
  });

  Vue.component('product-more-details', {
    name: 'productMoreDetails',

    data: function () {
      return {
        information: window.productMoreDetails,
        productCollection: window.currentProduct.collection,
      };
    },

    computed: {
      infoItem() {
        return this.information[this.productCollection];
      },
    },

    methods: {
      unscapify(string) {
        return decodeURI(string);
      },
    },

    template: `
      <span v-if="infoItem.length > 0">
        <article v-for="(item, index) in infoItem"
          :key="index"
          class="product-more-details__item">
          <small class="layout-section__eyebrow">{{ unscapify(item.eyebrow) }}</small>
          <p class="layout-section__description">{{ unscapify(item.description) }}</p>
          <span class="separator"></span>
        </article>
      </span>
    `,
  });

  Vue.component('product-media-video', {
    name: 'productMediaVideo',

    data: function () {
      return {
        information: window.productMedia,
        productCollection: window.currentProduct.collection,
      };
    },

    computed: {
      infoItem() {
        return this.information[this.productCollection] ? this.information[this.productCollection].video : [];
      },

      getUrls() {
        const base = 'https://fast.wistia.com/embed/medias/';
        return {
          js: `${base}${this.infoItem}.jsonp`,
          img: `${base}${this.infoItem}/swatch`,
          class: ['wistia_embed', `wistia_async_${this.infoItem}`, 'videoFoam=true'],
        };
      },
    },

    template: `
      <div class="media-video__iframe-wrapper">
        <script :src="getUrls.js" async></script>
        <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
          <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div :class="getUrls.class" style="height:100%;position:relative;width:100%">
              <div class="wistia_swatch" style="height:100%;left:0;opacity:0;overflow:hidden;position:absolute;top:0;transition:opacity 200ms;width:100%;">
                <img :src="getUrls.img"
                  style="filter:blur(5px);height:100%;object-fit:contain;width:100%;"
                  alt=""
                  onload="this.parentNode.style.opacity=1;" />
              </div>
            </div>
          </div>
        </div>
      </div>
    `,
  });

  Vue.component('product-media-images', {
    name: 'productMediaImages',

    data: function () {
      return {
        information: window.productMedia,
        productCollection: window.currentProduct.collection,
      };
    },

    computed: {
      infoItem() {
        return this.information[this.productCollection] ? this.information[this.productCollection].images : [];
      },
    },

    template: `
      <div v-if="infoItem.length > 0" class="product-media__carousel js-slick-product-media">
        <div v-for="(item, index) in infoItem"
          :key="index"
          class="product-media__carousel-item">
          <img class="product-media__carousel-image"
            :src="item" />
        </div>
      </div>
    `,
  });

  Vue.component('product-faq', {
    name: 'productFaq',

    data: function () {
      return {
        information: window.productFaq,
        productCollection: window.currentProduct.collection,
      };
    },

    computed: {
      infoItem() {
        return this.information[this.productCollection];
      },
    },

    template: `
      <div class="accordion product-faq__items js-product-faq-items">
        <template v-for="(item, index) in infoItem">
          <h2 class="accordion__header product-faq__item-header">{{ item.question }}</h2>
          <div class="accordion__content product-faq__item-contnet">
            <p class="accordion__text product-faq__item-description">{{ item.answer }}</p>
          </div>
        </template>
      </div>
    `,
  });

  new Vue({
    el: '#product-info',
  });
}

var position = $(window).scrollTop();
var siteWidth = window.innerWidth;
var navElem = $('.js-header-main');
var navClass = 'main-nav--sticky';

if ($('body').hasClass('has-sticky-nav')) {
  $(window).scroll(function() {
    if (window.innerWidth > 1023) {
      var scroll = $(window).scrollTop();
      if(window.scrollY < 7) {
        navElem.removeClass(navClass);

      } else if (scroll < (position - 5)) {
        navElem.addClass(navClass);

      } else if ((scroll > position) && navElem.hasClass(navClass)) {
        navElem.addClass('leaving');

        setTimeout(function() {
          navElem.removeClass('leaving');
          navElem.removeClass(navClass);
        }, 200);
      }

      position = scroll;
    }
  });
}

window.template = (function() {
  var classes = {
    domReady: 'dom-ready',
  };

  function domReady() {
    $('html').addClass(classes.domReady);
  }

  function init() {
    domReady();
  }

  return {
    init: init,
  };
})();

var imageService = function(img, w, h = w) {
  var imgSplit = img.split('.');
  var imgFormat = imgSplit[imgSplit.length - 1];
  var imgFirst = img.split('.'+imgFormat)[0];

  return imgFirst + '_' + w + 'x' + h + '.' + imgFormat;
};

var addToCart = function(id, cb) {
  $.ajax({
    url: '/cart/add.js',
    method: 'POST',
    dataType: 'json',
    data: {
      quantity: 1,
      id,
    },
    success: function(data) {
      cb(data);
    }
  });
};

var getUrlParameter = function(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  var results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
